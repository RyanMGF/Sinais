<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinais de Emoções</title>
    
    <!-- Tailwind CSS -->

    <style>
        /* --- FONT-FACE DEFINITIONS --- */
        @font-face {
            font-family: 'Poppins';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('./fonts/poppins-v21-latin-regular.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Poppins';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('./fonts/poppins-v21-latin-600.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Poppins';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('./fonts/poppins-v21-latin-700.woff2') format('woff2');
        }

        /* --- THEME VARIABLES --- */
        :root {
            --color-bg-primary: 249 250 251;
            --color-bg-secondary: 255 255 255;
            --color-bg-tertiary: 243 244 246;
            --color-bg-input: 255 255 255;
            --color-text-primary: 17 24 39;
            --color-text-secondary: 107 114 128;
            --color-text-muted: 156 163 175;
            --color-border-primary: 229 231 235;
            --color-accent: 20 184 166;
            --color-accent-hover: 15 159 132;
            --color-accent-text: 255 255 255;
            --color-accent-bg-light: 204 251 241;
            --color-accent-text-dark: 15 118 110;
        }
        [data-theme="dark"] {
            --color-bg-primary: 17 24 39;
            --color-bg-secondary: 31 41 55;
            --color-bg-tertiary: 55 65 81;
            --color-bg-input: 55 65 81;
            --color-text-primary: 229 231 235;
            --color-text-secondary: 156 163 175;
            --color-text-muted: 107 114 128;
            --color-border-primary: 55 65 81;
            --color-accent-bg-light: 13 47 42;
            --color-accent-text-dark: 107 235 208;
        }
        [data-theme="ocean"] {
            --color-bg-primary: 15 23 42;
            --color-bg-secondary: 30 41 59;
            --color-bg-tertiary: 51 65 85;
            --color-bg-input: 51 65 85;
            --color-text-primary: 226 232 240;
            --color-text-secondary: 148 163 184;
            --color-text-muted: 100 116 139;
            --color-border-primary: 71 85 105;
            --color-accent: 34 211 238;
            --color-accent-hover: 6 182 212;
            --color-accent-text: 15 23 42;
            --color-accent-bg-light: 165 243 252;
            --color-accent-text-dark: 22 78 99;
        }

        /* --- GENERAL RESETS & BODY STYLING --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: rgb(var(--color-bg-primary));
            color: rgb(var(--color-text-primary));
            line-height: 1.6;
        }
        .hidden { display: none !important; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgb(var(--color-bg-tertiary));
        }
        ::-webkit-scrollbar-thumb {
            background: rgb(var(--color-text-muted));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(var(--color-text-secondary));
        }

        /* --- LAYOUT & STRUCTURE --- */
        #app-container {
            max-width: 512px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: rgb(var(--color-bg-secondary));
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        #app-header {
            padding: 1rem;
            border-bottom: 1px solid rgb(var(--color-border-primary));
        }
        #app-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            color: rgb(var(--color-text-primary));
        }
        main {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* --- SCREEN & ANIMATIONS --- */
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 { color: rgb(var(--color-text-primary)); }
        h1 { font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem; }
        h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; }
        h4 { font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; }
        p { margin-bottom: 1rem; color: rgb(var(--color-text-secondary)); }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-muted { color: rgb(var(--color-text-muted)); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }

        /* --- BUTTONS --- */
        button {
            border: none;
            background: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: opacity 0.2s, background-color 0.2s, border-color 0.2s;
        }
        .button-primary {
            background-color: rgb(var(--color-accent));
            color: rgb(var(--color-accent-text));
            font-weight: 700;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .button-primary:hover { background-color: rgb(var(--color-accent-hover)); }
        .button-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .mood-btn {
            width: 100%;
            color: white;
            font-weight: 700;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .mood-btn:hover { transform: scale(1.05); }
        .mood-btn.green { background-color: #16a34a; } .mood-btn.green:hover { background-color: #15803d; }
        .mood-btn.amber { background-color: #d97706; } .mood-btn.amber:hover { background-color: #b45309; }
        .mood-btn.red { background-color: #dc2626; } .mood-btn.red:hover { background-color: #b91c1c; }

        /* --- FORMS & INPUTS --- */
        .input-group { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
        .input-field, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgb(var(--color-border-primary));
            border-radius: 0.5rem;
            background-color: rgb(var(--color-bg-input));
            color: rgb(var(--color-text-primary));
        }
        textarea { resize: vertical; }
        .input-field:focus, textarea:focus {
            outline: none;
            border-color: rgb(var(--color-accent));
            box-shadow: 0 0 0 2px rgba(var(--color-accent), 0.3);
        }

        /* --- ICONS --- */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- NAVIGATION --- */
        #bottom-nav-bar {
            width: 100%;
            max-width: 512px;
            margin: 0 auto;
            background-color: rgb(var(--color-bg-secondary));
            border-top: 1px solid rgb(var(--color-border-primary));
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        #bottom-nav {
            display: flex;
            justify-content: space-around;
        }
        .nav-btn {
            flex: 1;
            padding: 0.75rem 0;
            text-align: center;
            color: rgb(var(--color-text-muted));
        }
        .nav-btn .icon { margin: 0 auto 0.25rem; width: 24px; height: 24px; }
        .nav-btn span { font-size: 0.75rem; display: block; }
        .nav-btn.active { color: rgb(var(--color-accent)); }
        #nav-spacer { height: 80px; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }
        .modal-content {
            background-color: rgb(var(--color-bg-secondary));
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 100%;
            max-width: 448px;
            padding: 1.5rem;
        }
        .modal-enter {
            animation: modal-in 0.3s ease-out;
        }
        .modal-leave {
            animation: modal-out 0.3s ease-in forwards;
        }
        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes modal-out {
            from { opacity: 1; transform: scale(1) translateY(0); } to { opacity: 0; transform: scale(0.95) translateY(10px); }
        }

        /* --- LIST ITEM ANIMATIONS --- */
        .list-item-enter {
            animation: slideIn 0.4s ease-out forwards;
        }
        .list-item-leave {
            animation: slideOut 0.4s ease-in forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: scale(1); }
            to {
                opacity: 0;
                transform: scale(0.9);
                height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-bottom: 0;
                border-width: 0;
            }
        }
        /* --- SPECIFIC SCREEN STYLES --- */
        .welcome-screen { text-align: center; }
        .welcome-screen .icon { width: 5rem; height: 5rem; color: rgb(var(--color-accent)); margin-bottom: 1.5rem; }
        .welcome-screen h1 { font-size: 2rem; }
        .welcome-screen p { font-size: 1.125rem; max-width: 448px; margin-left: auto; margin-right: auto; }
        .welcome-screen .button-primary { margin-top: 1rem; }

        .contact-card {
            background-color: rgb(var(--color-bg-tertiary));
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            overflow: hidden; /* For animations */
        }

        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tag-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: rgb(var(--color-bg-tertiary));
            color: rgb(var(--color-text-primary));
        }
        .tag-btn.selected {
            background-color: rgb(var(--color-accent));
            color: rgb(var(--color-accent-text));
        }

        .journey-link {
            width: 100%;
            background-color: rgb(var(--color-bg-secondary));
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgb(var(--color-border-primary));
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: left;
        }
        .journey-link:hover { border-color: rgb(var(--color-accent)); }
        .journey-link .icon { width: 2rem; height: 2rem; color: rgb(var(--color-accent)); margin-right: 1rem; }
        .journey-link h4 { margin-bottom: 0.25rem; }
        .journey-link p { margin-bottom: 0; font-size: 0.875rem; }

        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            text-align: center;
        }
        .calendar-day {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
        }
        .calendar-day.today { background-color: rgb(var(--color-accent-bg-light)); }
        .calendar-day.selected { border: 2px solid rgb(var(--color-accent)); }
        .mood-dot {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .history-item {
            background-color: rgb(var(--color-bg-secondary));
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .history-item-content { flex-grow: 1; }
        .history-item-actions { display: flex; gap: 0.75rem; }

        .simple-bar-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 150px;
            padding: 1rem;
            border: 1px solid rgb(var(--color-border-primary));
            border-radius: 0.5rem;
        }
        .bar-item { text-align: center; width: 50px; }
        .bar {
            width: 100%;
            background-color: rgb(var(--color-accent));
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease-out;
        }
        .bar-item span { font-size: 0.875rem; margin-top: 0.5rem; display: block; }

        .simple-pie-chart {
            background-color: rgb(var(--color-bg-tertiary));
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .theme-btn {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid rgb(var(--color-border-primary));
            font-weight: 600;
        }
        .theme-btn.active {
            border-color: rgb(var(--color-accent));
            color: rgb(var(--color-accent));
        }

        .space-y-2 > *:not(:first-child) { margin-top: 0.5rem; }
        .space-y-3 > *:not(:first-child) { margin-top: 0.75rem; }
        .space-y-4 > *:not(:first-child) { margin-top: 1rem; }
        .space-y-6 > *:not(:first-child) { margin-top: 1.5rem; }

        .gratitude-item, .goal-item, .tag-management-item {
            overflow: hidden; /* For animations */
        }
        .gratitude-item {
            background-color: rgb(var(--color-bg-secondary)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary));
            margin-bottom: 0.75rem;
        }
        .goal-item {
            background-color: rgb(var(--color-bg-secondary)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary)); display: flex; align-items: center; gap: 1rem;
            margin-bottom: 0.75rem;
        }
        .tag-management-item {
            background-color: rgb(var(--color-bg-secondary)); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary)); display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.5rem;
        }
        #gratitude-entries-list > *:last-child, #goals-list > *:last-child, #tag-management-list > *:last-child {
            margin-bottom: 0;
        }

        .data-management-section {
            margin-top: 2rem;
            background-color: rgb(var(--color-bg-secondary));
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgb(var(--color-border-primary));
        }
        .data-management-section .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .data-management-section .button-group button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            background-color: rgb(var(--color-bg-tertiary));
            color: rgb(var(--color-text-primary));
        }

        .button-primary.feedback-green { background-color: #22c55e; }
        .button-primary.feedback-green:hover { background-color: #16a34a; }
        .button-primary.feedback-amber { background-color: #f59e0b; }
        .button-primary.feedback-amber:hover { background-color: #b45309; }
        .button-primary.feedback-red { background-color: #ef4444; }
        .button-primary.feedback-red:hover { background-color: #b91c1c; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- App Header -->
        <header id="app-header" class="hidden">
            <h1></h1>
        </header>

        <main>
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                <svg class="icon" style="width: 5rem; height: 5rem; color: rgb(var(--color-accent)); margin-bottom: 1.5rem;" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <h1 style="font-size: 2rem;">Bem-vindo(a) ao<br>Sinais de Emoções</h1>
                <p style="font-size: 1.125rem; max-width: 448px; margin-left: auto; margin-right: auto;">Seu espaço seguro para navegar pelas emoções.</p>
                <p style="max-width: 448px; margin-left: auto; margin-right: auto; margin-bottom: 2rem;">Aqui, você pode registrar o que sente, entender seus padrões e encontrar recursos para cuidar do seu bem-estar.</p>

                <button id="get-started-btn" class="button-primary">
                    Começar
                </button>
            </div>

            <!-- Mandatory Contact Screen -->
            <div id="mandatory-contact-screen" class="screen">
                <div class="text-center" style="margin-bottom: 1.5rem;">
                    <svg class="icon" style="width: 4rem; height: 4rem; color: rgb(var(--color-accent)); margin: 0 auto 1rem;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <h2>Crie sua Rede de Apoio</h2>
                    <p>Recomendamos fortemente que adicione um contato de confiança. Em momentos difíceis, ter alguém para conversar pode fazer toda a diferença. Você pode pular esta etapa e adicionar contatos mais tarde nos Ajustes.</p>
                </div>
                <div id="mandatory-contacts-list" style="margin-bottom: 1.5rem;"></div>
                <div style="background-color: rgb(var(--color-bg-secondary)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary));">
                    <h4 class="font-semibold" style="margin-bottom: 0.75rem;">Adicionar Contato</h4>
                    <div class="input-group">
                        <input type="text" id="mandatory-contact-name-input" class="input-field" placeholder="Nome (Ex: Mãe)">
                        <input type="tel" id="mandatory-contact-phone-input" class="input-field" placeholder="Telefone">
                    </div>
                    <button id="add-mandatory-contact-btn" style="width: 100%; background-color: rgb(var(--color-bg-tertiary)); color: rgb(var(--color-text-primary)); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem;">
                        Adicionar
                    </button>
                </div>
                <button id="mandatory-contact-continue-btn" class="button-primary" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                    Concluir
                </button>
                <button id="skip-contact-btn" style="width: 100%; text-align: center; margin-top: 1rem; color: rgb(var(--color-text-muted)); font-weight: 600;">Pular por agora</button>
            </div>

            <!-- Emotional Check-in Screen -->
            <div id="checkin-screen" class="screen text-center" style="padding-top: 2rem;">
                <p style="font-size: 1.125rem; margin-bottom: 2rem;">Escolha a cor que melhor representa seu sentimento agora.</p>
                <div class="space-y-4">
                    <button data-mood="verde" class="mood-btn green">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5-2 4-2 4 2 4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg> Siga em Frente
                    </button>
                    <button data-mood="amarelo" class="mood-btn amber">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg> Atenção
                    </button>
                    <button data-mood="vermelho" class="mood-btn red">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg> Pare
                    </button>
                </div>
            </div>

            <!-- Check-in Details Screen -->
            <div id="details-screen" class="screen">
                <form id="details-form">
                    <div style="margin-bottom: 1.5rem;">
                        <label class="font-semibold" style="display: block; font-size: 1.125rem; margin-bottom: 0.5rem;">Tags de Contexto</label>
                        <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.75rem;">Selecione uma ou mais tags que se aplicam.</p>
                        <div id="predefined-tags-container" class="tag-container"></div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label for="notes" class="font-semibold" style="display: block; font-size: 1.125rem; margin-bottom: 0.5rem;">Notas (Opcional)</label>
                        <textarea id="notes" rows="5" class="input-field" placeholder="O que aconteceu? Descreva a situação ou o sentimento."></textarea>
                    </div>
                    <button type="submit" id="save-checkin-btn" class="button-primary" style="width: 100%; padding: 1rem;">
                        Salvar Registro
                    </button>
                </form>
            </div>

            <!-- Feedback Screen -->
            <div id="feedback-screen" class="screen flex flex-col items-center justify-center h-full text-center">
                <div id="feedback-icon-container" style="width: 5rem; height: 5rem; margin-bottom: 1.5rem;"></div>
                <h1 id="feedback-title">Que bom!</h1>
                <p id="feedback-message" style="margin-bottom: 2rem;">É ótimo ver que você está se sentindo bem. Continue assim!</p>
                <button id="feedback-continue-btn" class="button-primary">
                    Continuar
                </button>
            </div>

            <!-- Contextual Tips Screen -->
            <div id="contextual-tips-screen" class="screen">
                <h2 class="text-2xl font-bold mb-4 text-center">Dicas para seu Momento</h2>
                <p class="text-center" style="margin-bottom: 2rem;">Com base no que você compartilhou, aqui estão algumas sugestões.</p>
                <div id="tips-container" class="space-y-6" style="margin-bottom: 2rem;">
                    <!-- Tips will be rendered here by JS -->
                </div>
                <button id="tips-continue-btn" class="button-primary" style="width: 100%;">
                    Entendido
                </button>
            </div>

            <!-- Weekly Diagnosis Screen -->
            <div id="diagnosis-screen" class="screen">
                <h3 class="text-2xl font-bold mb-2 text-center">Diagnóstico Semanal</h3>
                <p class="text-muted text-center" style="margin-bottom: 2rem;">Um resumo dos seus sentimentos nos últimos 7 dias.</p>
                
                <div id="diagnosis-content" class="hidden">
                    <div style="margin-bottom: 2rem;">
                        <h4 class="text-xl font-bold mb-4 text-center">Balanço da Semana</h4>
                        <div id="weekly-bar-chart-container"></div>
                    </div>
                    <div id="diagnosis-feedback" style="background-color: rgb(var(--color-bg-tertiary)); padding: 1.5rem; border-radius: 0.5rem;">
                        <h4 id="diagnosis-title" class="text-xl font-bold mb-3"></h4>
                        <p id="diagnosis-text" class="text-text-primary"></p>
                    </div>
                </div>
                <div id="no-diagnosis-data" class="text-center text-muted hidden" style="padding: 4rem 0;">
                    <svg class="icon" style="width: 4rem; height: 4rem; margin: 0 auto 1rem;" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <p>Não há registros suficientes na última semana para gerar um diagnóstico.</p>
                </div>
            </div>

            <!-- Gratitude Journal Screen -->
            <div id="gratitude-journal-screen" class="screen">
                <h3 class="text-2xl font-bold mb-2 text-center">Diário de Gratidão</h3>
                <p class="text-muted text-center" style="margin-bottom: 2rem;">Registre as coisas pelas quais você é grato(a) hoje.</p>
                <div style="margin-bottom: 1.5rem;">
                    <textarea id="new-gratitude-entry-input" rows="3" class="input-field" placeholder="Hoje sou grato(a) por..."></textarea>
                    <button type="button" id="add-new-gratitude-entry-btn" class="button-primary" style="width: 100%; margin-top: 0.75rem; border-radius: 0.5rem; padding: 0.75rem;">
                        Adicionar Gratidão
                    </button>
                </div>
                <div id="gratitude-entries-list">
                    <!-- Entries will be rendered here -->
                </div>
            </div>

            <!-- Journey Hub Screen -->
            <div id="journey-screen" class="screen">
                <h3 class="text-center" style="margin-bottom: 2rem;">Sua Jornada</h3>
                <div class="space-y-4">
                    <button data-screen="history-screen" class="journey-link">
                        <div style="display: flex; align-items: center;">
                            <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                            <div>
                                <h4>Histórico</h4>
                                <p>Veja seus registros e padrões.</p>
                            </div>
                        </div>
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                    <button data-screen="diagnosis-screen" class="journey-link">
                        <div style="display: flex; align-items: center;">
                            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                            <div>
                                <h4>Diagnóstico</h4>
                                <p>Análise do seu humor semanal.</p>
                            </div>
                        </div>
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                    <button data-screen="achievements-screen" class="journey-link">
                        <div style="display: flex; align-items: center;">
                            <svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            <div>
                                <h4>Conquistas</h4>
                                <p>Acompanhe seu progresso.</p>
                            </div>
                        </div>
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                    <button data-screen="goals-screen" class="journey-link">
                        <div style="display: flex; align-items: center;">
                            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                            <div>
                                <h4>Metas</h4>
                                <p>Defina seus objetivos.</p>
                            </div>
                        </div>
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                    <button data-screen="gratitude-journal-screen" class="journey-link">
                        <div style="display: flex; align-items: center;">
                            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                            <div>
                                <h4>Diário de Gratidão</h4>
                                <p>Foque nos pontos positivos.</p>
                            </div>
                        </div>
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </div>

            <!-- History Dashboard Screen -->
            <div id="history-screen" class="screen">
                <div id="calendar-view" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button id="prev-month-btn" style="padding: 0.5rem; border-radius: 50%;"><svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                        <h3 id="calendar-month-year" style="font-size: 1.25rem; text-transform: capitalize; margin: 0;"></h3>
                        <button id="next-month-btn" style="padding: 0.5rem; border-radius: 50%;"><svg class="icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                    </div>
                    <div id="calendar-grid">
                        <!-- Calendar will be rendered here by JS -->
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <button id="zen-mode-toggle" title="Modo Zen" style="display: flex; align-items: center; gap: 0.5rem; color: rgb(var(--color-text-muted)); padding: 0.5rem; border-radius: 0.5rem;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>
                        <span style="font-size: 0.875rem; font-weight: 600;">Modo Zen</span>
                    </button>
                </div>

                <div id="history-filter-container" style="margin-bottom: 1.5rem; display: none;">
                    <h4 class="font-semibold text-center" style="margin-bottom: 0.75rem;">Filtrar por Tag</h4>
                    <div id="history-tags-filter" class="tag-container" style="justify-content: center;">
                        <!-- Filter tags will be rendered here by JS -->
                    </div>
                </div>
                <div id="history-content">
                    <div id="charts-container">
                        <div style="margin-bottom: 2rem;">
                            <h4 class="text-center">Tendência Emocional</h4>
                            <div id="trend-chart-container"></div>
                        </div>
                        <div style="margin-bottom: 2rem;">
                            <h4 class="text-center">Frequência de Emoções</h4>
                            <div id="mood-pie-chart-container" style="max-width: 288px; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-center">Registros Recentes</h4>
                        <div id="history-list" class="space-y-3"></div>
                    </div>
                </div>
                <div id="no-history" class="text-center text-muted hidden" style="padding: 4rem 0;">
                    <svg class="icon" style="width: 4rem; height: 4rem; margin: 0 auto 1rem;" viewBox="0 0 24 24"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
                    <p>Nenhum registro encontrado ainda.</p>
                </div>
            </div>

            <!-- Resource Library Screen -->
            <div id="resources-screen" class="screen">
                <div id="emergency-help-section" style="margin-bottom: 2rem; padding: 1.5rem; border-radius: 0.5rem; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); text-align: center;">
                    <h3 style="color: #ef4444; margin-bottom: 0.5rem;">Ajuda Urgente</h3>
                    <p style="margin-bottom: 1rem;">Se você está em uma crise, ligue para o Centro de Valorização da Vida (CVV).</p>
                    <a href="tel:188" class="button-primary" style="background-color: #ef4444; display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 0.75rem;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> Ligar para CVV - 188
                    </a>
                    <div id="favorite-contacts-container" style="width: 100%; margin-top: 1.5rem;">
                        <!-- Favorite contacts will be rendered here -->
                    </div>
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                        <h4 class="font-semibold text-left" style="margin-bottom: 0.75rem;">Adicionar Novo Contato</h4>
                        <div class="input-group">
                            <input type="text" id="resources-contact-name-input" class="input-field" placeholder="Nome">
                            <input type="tel" id="resources-contact-phone-input" class="input-field" placeholder="Telefone">
                        </div>
                        <button id="add-resources-contact-btn" class="button-primary" style="width: 100%; border-radius: 0.5rem; padding: 0.5rem 1rem;">
                            Adicionar à Rede
                        </button>
                    </div>
                </div>
                <div id="suggested-resources" style="margin-bottom: 2rem;"></div>
                <div id="all-resources">
                    <h4>Biblioteca Completa</h4>
                    <div id="resources-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settings-screen" class="screen">
                <h3>Configurações</h3>
                <div class="space-y-4">
                    <div style="background-color: rgb(var(--color-bg-secondary)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary));">
                        <h4>Tema</h4>
                        <div id="theme-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button data-theme="light" class="theme-btn">Claro</button>
                            <button data-theme="dark" class="theme-btn">Escuro</button>
                            <button data-theme="ocean" class="theme-btn">Oceano</button>
                        </div>
                    </div>
                    <div style="margin-top: 2rem;">
                        <h4>Gerenciar Tags</h4>
                        <div class="input-group" style="margin-bottom: 1rem;">
                            <input type="text" id="new-tag-input" class="input-field" placeholder="Adicionar nova tag...">
                            <button type="button" id="add-new-tag-btn" class="button-primary" style="padding: 0.75rem; border-radius: 0.5rem; flex-shrink: 0;">
                                <svg class="icon" style="color: rgb(var(--color-accent-text));" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                        <div id="tag-management-list">
                            <!-- Tags will be rendered here by JS -->
                        </div>
                    </div>
                    <div class="data-management-section">
                        <h4>Gerenciamento de Dados</h4>
                        <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 0;">Salve seus dados em um arquivo ou restaure um backup.</p>
                        <div class="button-group">
                            <button id="export-data-btn">Exportar Dados</button>
                            <button id="import-data-btn">Importar Dados</button>
                        </div>
                        <input type="file" id="import-file-input" class="hidden" accept="application/json">
                    </div>
                </div>
            </div>

            <!-- Achievements Screen -->
            <div id="achievements-screen" class="screen">
                <h3 class="text-center">Minhas Conquistas</h3>
                <p class="text-muted text-center" style="margin-bottom: 2rem;">Continue registrando para desbloquear todas!</p>
                <div id="achievements-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Achievements will be rendered here -->
                </div>
            </div>

            <!-- Goals Screen -->
            <div id="goals-screen" class="screen">
                <h3 class="text-center">Minhas Metas</h3>
                <p class="text-muted text-center" style="margin-bottom: 2rem;">Defina objetivos para seu bem-estar emocional.</p>
                <div class="input-group" style="margin-bottom: 1.5rem;">
                    <input type="text" id="new-goal-input" class="input-field" placeholder="Ex: Meditar 5 minutos por dia">
                    <button type="button" id="add-new-goal-btn" class="button-primary" style="padding: 0.75rem; border-radius: 0.5rem; flex-shrink: 0;">
                        <svg class="icon" style="color: rgb(var(--color-accent-text));" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="goals-list">
                    <!-- Goals will be rendered here -->
                </div>
            </div>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav-bar" class="hidden">
            <div id="bottom-nav">
                <button data-screen="checkin-screen" class="nav-btn flex-1 py-3 text-center text-text-muted">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Início</span>
                </button>
                <button data-screen="journey-screen" class="nav-btn flex-1 py-3 text-center text-text-muted">
                    <svg class="icon" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg><span>Jornada</span>
                </button>
                <button data-screen="resources-screen" class="nav-btn flex-1 py-3 text-center text-text-muted">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span>Recursos</span>
                </button>
                <button data-screen="settings-screen" class="nav-btn flex-1 py-3 text-center text-text-muted">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span>Ajustes</span>
                </button>
            </div>
        </nav>
        
        <!-- Spacer to prevent content from being hidden by the nav bar -->
        <div id="nav-spacer" class="hidden"></div>

        <!-- Edit Modal -->
        <div id="edit-modal" class="modal-overlay hidden">
            <div id="edit-modal-content" class="modal-content">
                <h3>Editar Registro</h3>
                <form id="edit-form">
                    <div style="margin-bottom: 1.5rem;">
                        <label for="edit-notes" class="font-semibold" style="display: block; font-size: 1.125rem; margin-bottom: 0.5rem;">Notas</label>
                        <textarea id="edit-notes" rows="5" class="input-field"></textarea>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="font-semibold" style="display: block; font-size: 1.125rem; margin-bottom: 0.5rem;">Tags</label>
                        <div id="edit-predefined-tags-container" class="tag-container"></div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                        <button type="button" id="cancel-edit-btn" style="padding: 0.5rem 1.5rem; background-color: rgb(var(--color-bg-tertiary)); color: rgb(var(--color-text-primary)); border-radius: 0.5rem;">Cancelar</button>
                        <button type="submit" id="save-edit-btn" class="button-primary" style="padding: 0.5rem 1.5rem; border-radius: 0.5rem;">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Achievement Unlocked Modal -->
        <div id="achievement-unlocked-modal" class="modal-overlay hidden">
            <div id="achievement-modal-content" class="modal-content text-center" style="max-width: 384px;">
                <svg class="icon" style="width: 4rem; height: 4rem; color: rgb(var(--color-accent)); margin: 0 auto 1rem;" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>
                <h2>Conquista Desbloqueada!</h2>
                <p id="unlocked-achievement-title" class="font-semibold" style="color: rgb(var(--color-accent)); font-size: 1.125rem;"></p>
                <p id="unlocked-achievement-desc" style="margin-bottom: 1.5rem;"></p>
                <button id="close-achievement-modal-btn" class="button-primary" style="width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem;">
                    Legal!
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT & INITIALIZATION ---
            const state = {
                currentScreen: 'welcome-screen',
                checkins: [],
                isAuthenticated: false,
                editingCheckinId: null,
                editingTags: [],
                calendarDate: new Date(),
                selectedDate: null,
                isZenMode: false,
                streaks: { current: 0, longest: 0 },
                unlockedAchievements: [],
                gratitudeEntries: [],
                goals: [],
                historyFilterTag: null,
                favoriteContacts: [],
                theme: 'light',
                predefinedTags: ["Trabalho", "Família", "Relacionamentos", "Saúde", "Lazer", "Estudos", "Finanças", "Pessoal"], // Default tags
                currentMood: null,
                currentTags: [],
            };

            const iconLibrary = {
                'award': '<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>',
                'calendar': '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
                'trending-up': '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>',
                'shield': '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>',
                'briefcase': '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>',
                'users': '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',
                'heart': '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',
                'dollar-sign': '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
                'wind': '<path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path>',
                'headphones': '<path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H2z"></path>',
                'edit-3': '<path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>',
                'activity': '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>',
                'youtube': '<path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>',
                'book-open': '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>',
                'life-buoy': '<circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"></line><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line>',
                'archive': '<polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line>',
                'filter': '<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>',
            };

            // --- MOCK DATA ---
            const achievementsData = [
                { id: 'streak-3', title: 'Início Consistente', description: 'Registrou o humor por 3 dias seguidos.', icon: 'award', requirement: { type: 'streak', value: 3 } },
                { id: 'streak-7', title: 'Hábito Semanal', description: 'Registrou o humor por 7 dias seguidos.', icon: 'calendar', requirement: { type: 'streak', value: 7 } },
                { id: 'streak-14', title: 'Jornada de Autocuidado', description: 'Registrou o humor por 14 dias seguidos.', icon: 'trending-up', requirement: { type: 'streak', value: 14 } },
                { id: 'streak-30', title: 'Mestre da Consciência', description: 'Registrou o humor por 30 dias seguidos.', icon: 'shield', requirement: { type: 'streak', value: 30 } },
            ];

            // A lista de tags foi movida para o objeto 'state' para ser personalizável
            const mockResources = [
                // Contextual resources based on tags
                { id: "10", title: "Lidando com Pressão no Trabalho", description: "Estratégias para gerenciar o estresse profissional.", type: "article", contentUrl: "#", icon: "briefcase", category: "contextual", tags: ["Trabalho"] },
                { id: "11", title: "Comunicação Familiar Positiva", description: "Dicas para melhorar o diálogo com seus familiares.", type: "article", contentUrl: "#", icon: "users", category: "contextual", tags: ["Família"] },
                { id: "12", title: "Cuidando da Saúde Mental", description: "Um guia para priorizar seu bem-estar emocional.", type: "video", contentUrl: "#", icon: "heart", category: "contextual", tags: ["Saúde", "Pessoal"] },
                { id: "13", title: "Finanças e Bem-estar", description: "Como a organização financeira impacta suas emoções.", type: "article", contentUrl: "#", icon: "dollar-sign", category: "contextual", tags: ["Finanças"] },
                // General Calm/Release resources
                { id: "1", title: "Técnicas de Respiração", description: "Aprenda a controlar a ansiedade com exercícios simples.", type: "article", contentUrl: "#", icon: "wind", category: "calm", tags: [] },
                { id: "2", title: "Meditação Guiada para Acalmar", description: "Relaxe e encontre seu centro com esta meditação.", type: "audio", contentUrl: "#", icon: "headphones", category: "calm", tags: [] },
                { id: "3", title: "Diário Expressivo", description: "Escreva sobre seus sentimentos sem julgamento para clarear a mente.", type: "activity", contentUrl: "#", icon: "edit-3", category: "release", tags: [] },
                { id: "4", title: "Movimente o Corpo", description: "Uma caminhada rápida ou dança pode ajudar a aliviar o estresse.", type: "activity", contentUrl: "#", icon: "activity", category: "release", tags: [] },
                // General resources
                { id: "9", title: "O Poder do Pensamento Positivo", description: "Um vídeo sobre como mudar sua perspectiva.", type: "video", contentUrl: "#", icon: "youtube", category: "general", tags: [] },
            ];
            const contextualTipsData = {
                "Estudos": {
                    icon: "book-open",
                    title: "Lidando com a Pressão dos Estudos",
                    texts: [
                        "Divida suas tarefas em partes menores e celebre cada pequena conquista. Lembre-se de fazer pausas regulares para descansar a mente.",
                        "Tente a técnica Pomodoro: 25 minutos de foco intenso e 5 minutos de descanso. Isso pode aumentar sua produtividade e diminuir a ansiedade.",
                        "Conversar com colegas sobre as dificuldades também pode aliviar o peso. Vocês não estão sozinhos nisso."
                    ]
                },
                "Trabalho": {
                    icon: "briefcase",
                    title: "Gerenciando o Estresse no Trabalho",
                    texts: [
                        "Defina limites claros entre o trabalho e a vida pessoal. Desconectar é essencial para recarregar as energias.",
                        "Tente identificar a fonte do estresse. É uma tarefa específica? Um relacionamento? Saber a causa é o primeiro passo para resolver.",
                        "Pequenas pausas durante o dia são essenciais. Levante-se, alongue-se ou apenas olhe pela janela por alguns minutos."
                    ]
                },
                "Família": {
                    icon: "users",
                    title: "Navegando em Dinâmicas Familiares",
                    texts: [
                        "A comunicação aberta é fundamental. Tente expressar seus sentimentos de forma calma, usando frases como 'Eu sinto que...' em vez de acusações.",
                        "Lembre-se de que você não pode controlar a reação dos outros, mas pode controlar a sua. Respire fundo antes de responder.",
                        "Às vezes, um pouco de distância pode ser saudável. Permita-se ter seu próprio espaço para processar as emoções."
                    ]
                },
                "Relacionamentos": {
                    icon: "heart",
                    title: "Cuidando dos seus Relacionamentos",
                    texts: [
                        "Seja honesto(a) sobre seus sentimentos com a outra pessoa, mas escolha um bom momento para a conversa, quando ambos estiverem calmos.",
                        "Escutar ativamente é tão importante quanto falar. Tente entender o ponto de vista do outro sem interromper.",
                        "Reserve um tempo de qualidade para se conectar, mesmo que seja algo simples. A intenção de estar presente faz toda a diferença."
                    ]
                },
                "Finanças": {
                    icon: "dollar-sign",
                    title: "Enfrentando a Ansiedade Financeira",
                    texts: [
                        "O primeiro passo é organizar. Crie um orçamento simples para entender para onde seu dinheiro está indo. Conhecimento é poder.",
                        "Se a situação for complexa, buscar orientação de um profissional pode trazer clareza e alívio. Não hesite em pedir ajuda.",
                        "Foque em pequenos passos. Que tal cortar um gasto supérfluo essa semana ou pesquisar uma forma de renda extra? Cada passo conta."
                    ]
                },
                // A generic tip if no specific tag matches
                "generic": {
                    icon: "life-buoy",
                    title: "Um Passo de Cada Vez",
                    texts: [
                        "Reconhecer que você não está bem é um ato de coragem. Permita-se sentir, mas lembre-se de que as emoções são passageiras.",
                        "Respire fundo, contando até quatro ao inspirar e até seis ao expirar. Isso ajuda a acalmar o sistema nervoso.",
                        "Seja gentil com você mesmo hoje. Permita-se fazer algo que te conforte, por menor que seja.",
                        "Lembre-se: sentimentos são como nuvens, eles vêm e vão. Esta sensação não durará para sempre.",
                        "Foque no presente. O que você pode fazer nos próximos 5 minutos para se sentir um pouco melhor? Um copo d'água? Uma música?",
                        "Escrever sobre o que você está sentindo pode ajudar a organizar os pensamentos e aliviar a pressão.",
                        "Você é mais forte do que pensa. Você já superou 100% dos seus dias ruins até hoje.",
                        "Não se cobre perfeição. Apenas o fato de estar aqui, tentando, já é uma grande vitória.",
                        "O autocuidado não é egoísmo. É uma necessidade. O que seu corpo e sua mente estão pedindo agora?",
                        "Lembre-se de que você pode encontrar mais ferramentas e apoio na nossa seção de Recursos."
                    ]
                },
            };

            // --- DOM ELEMENTS ---
            const screens = document.querySelectorAll('.screen');
            const navButtons = document.querySelectorAll('.nav-btn');
            const header = document.getElementById('app-header');
            const headerTitle = document.querySelector('#app-header h1');
            const bottomNav = document.getElementById('bottom-nav');
            const bottomNavBar = document.getElementById('bottom-nav-bar');
            const navSpacer = document.getElementById('nav-spacer');
            const editModal = document.getElementById('edit-modal');
            
            const renderEmptyState = (element, iconKey, message) => {
                element.innerHTML = `
                    <svg class="icon" style="width: 4rem; height: 4rem; margin: 0 auto 1rem;" viewBox="0 0 24 24">${iconLibrary[iconKey] || ''}</svg>
                    <p>${message}</p>
                `;
            };

            // --- UTILITY FUNCTIONS ---
            const getMoodBorderColor = (mood) => ({
                verde: 'border-green-500',
                amarelo: 'border-amber-400',
                vermelho: 'border-red-500'
            }[mood] || 'border-gray-400');

            const getMoodName = (mood) => ({
                verde: 'Bem',
                amarelo: 'Ok',
                vermelho: 'Mal'
            }[mood] || 'N/A');

            // Helper to check if two dates are on the same day
            const isSameDay = (d1, d2) =>
                d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();

            // Helper to check if d2 is the day right after d1
            const isConsecutiveDay = (d1, d2) => {
                if (!d1 || !d2) return false;
                const nextDay = new Date(d1);
                nextDay.setHours(0, 0, 0, 0);
                nextDay.setDate(d1.getDate() + 1);
                return isSameDay(nextDay, d2);
            };

            // --- DATA PERSISTENCE (localStorage) ---
            const loadState = () => {
                // Para o modo de exposição, os dados não são carregados para garantir
                // que a tela de boas-vindas seja sempre exibida no início.
                // O estado inicial padrão será usado a cada recarga.
            };

            const saveState = () => {
                // Para o modo de exposição, os dados não são salvos para garantir
                // que cada sessão seja nova e independente, sem persistir informações.
            };

            const applyTheme = (theme) => {
                document.documentElement.dataset.theme = theme;
                updateThemeSelector();
            };

            // --- RENDERING & UI UPDATES ---
            const navigateTo = (screenId) => {
                state.currentScreen = screenId;
                screens.forEach(s => s.style.display = 'none');
                const screenEl = document.getElementById(screenId);

                // Use 'flex' for screens that are designed as flex containers for centering
                screenEl.style.display = screenEl.style.flexDirection ? 'flex' : 'block';

                // Update nav button styles
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.screen === screenId);
                });

                // Update header title
                const titles = {
                    'checkin-screen': 'Como você está?',
                    'mandatory-contact-screen': 'Rede de Apoio',
                    'journey-screen': 'Sua Jornada',
                    'history-screen': 'Meu Histórico',
                    'goals-screen': 'Minhas Metas',
                    'gratitude-journal-screen': 'Diário de Gratidão',
                    'achievements-screen': 'Minhas Conquistas',
                    'contextual-tips-screen': 'Dicas para Você',
                    'diagnosis-screen': 'Diagnóstico Semanal',
                    'resources-screen': 'Recursos e Ajuda',
                    'settings-screen': 'Ajustes',
                };
                headerTitle.textContent = titles[screenId] || '';

                if (screenId === 'details-screen') {
                    renderPredefinedTags('predefined-tags-container', state.currentTags);
                }
                if (screenId === 'settings-screen') {
                    renderTagManagement();
                }
                if (screenId === 'achievements-screen') {
                    renderAchievements();
                }
                if (screenId === 'goals-screen') {
                    renderGoals();
                }
                if (screenId === 'gratitude-journal-screen') {
                    renderGratitudeJournal();
                }
                if (screenId === 'history-screen') {
                    renderHistory();
                }
                if (screenId === 'resources-screen') {
                    renderResources();
                    renderEmergencyContacts();
                }
                if (screenId === 'diagnosis-screen') {
                    renderDiagnosis();
                }
            };

            const renderPredefinedTags = (containerId, selectedTags) => {
                const container = document.getElementById(containerId);
                container.innerHTML = state.predefinedTags.map(tag => {
                    const isSelected = selectedTags.includes(tag);
                    return `<button type="button" data-tag="${tag}" class="tag-btn ${isSelected ? 'selected' : ''}">${tag}</button>`;
                }).join('');
            };

            const createTagManagementElement = (tag) => {
                const div = document.createElement('div');
                div.className = 'tag-management-item';
                div.innerHTML = `
                    <span class="font-semibold" style="flex-grow: 1;">${tag}</span>
                    <button data-tag="${tag}" class="remove-managed-tag-btn text-text-muted hover:text-red-500">
                        <svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    </button>
                `;
                return div;
            };

            const renderTagManagement = () => {
                const container = document.getElementById('tag-management-list');
                if (!container) return;
                container.innerHTML = state.predefinedTags.map(tag => createTagManagementElement(tag).outerHTML).join('');
            };

            const renderEmergencyContacts = () => {
                const container = document.getElementById('favorite-contacts-container');
                if (state.favoriteContacts.length === 0) {
                    container.innerHTML = `
                        <div class="pt-6 border-t border-red-500/20">
                            <p class="text-sm text-center text-text-secondary">Nenhum contato de apoio adicionado ainda.</p>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = `
                    <div class="pt-6 border-t border-red-500/20">
                        <h4 class="text-center text-text-primary">Sua Rede de Apoio</h4>
                        <p class="text-sm text-center text-text-secondary" style="margin-bottom: 1rem;">Lembre-se das pessoas que se importam. Uma conversa pode fazer toda a diferença.</p>
                        <div id="resources-contacts-list" class="space-y-3">
                            ${state.favoriteContacts.map(contact => `
                                <div style="background-color: rgb(var(--color-bg-secondary)); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary)); display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                                    <a href="tel:${contact.phone}" style="flex-grow: 1; display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 0.25rem; text-decoration: none;">
                                        <svg class="icon" style="width: 1.5rem; height: 1.5rem; color: rgb(var(--color-accent));" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <span class="font-semibold" style="font-size: 1.125rem; color: rgb(var(--color-text-primary));">${contact.name}</span>
                                    </a>
                                    <button data-id="${contact.id}" class="remove-resources-contact-btn" style="color: rgb(var(--color-text-muted)); padding: 0.5rem; border-radius: 0.25rem;">
                                        <svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            };

            const renderContextualTips = () => {
                const tipsContainer = document.getElementById('tips-container');
                const lastCheckin = state.checkins.length > 0 ? [...state.checkins].sort((a, b) => b.createdAt - a.createdAt)[0] : null;
                
                if (!lastCheckin) {
                    tipsContainer.innerHTML = '';
                    return;
                }

                const checkinTags = lastCheckin.tags;
                let tipsHTML = '';

                const createTipCard = (tip) => {
                    // Select a random tip text from the array
                    const randomText = tip.texts[Math.floor(Math.random() * tip.texts.length)];
                    return `
                    <div style="background-color: rgb(var(--color-bg-tertiary)); padding: 1.25rem; border-radius: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <svg class="icon" style="width: 1.5rem; height: 1.5rem; color: rgb(var(--color-accent));" viewBox="0 0 24 24">${iconLibrary[tip.icon] || ''}</svg>
                            <h4>${tip.title}</h4>
                        </div>
                        <p class="text-text-primary">${randomText}</p>
                    </div>
                `;
                };

                if (checkinTags.length > 0) {
                    checkinTags.forEach(tag => {
                        if (contextualTipsData[tag]) {
                            tipsHTML += createTipCard(contextualTipsData[tag]);
                        }
                    });
                }

                if (tipsHTML === '') {
                    tipsHTML = createTipCard(contextualTipsData.generic);
                }

                tipsContainer.innerHTML = tipsHTML;
            };

            const renderFeedbackScreen = (mood) => {
                const iconContainer = document.getElementById('feedback-icon-container');
                const titleEl = document.getElementById('feedback-title');
                const messageEl = document.getElementById('feedback-message');
                const continueBtn = document.getElementById('feedback-continue-btn');

                const feedbackData = {
                    verde: {
                        iconSvg: '<svg class="icon" style="color: #22c55e;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5-2 4-2 4 2 4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
                        color: 'text-green-500',
                        title: 'Que bom!',
                        message: 'É ótimo ver que você está se sentindo bem. Continue assim!',
                        btnClass: 'feedback-green'
                    },
                    amarelo: {
                        iconSvg: '<svg class="icon" style="color: #f59e0b;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
                        color: 'text-amber-400',
                        title: 'Obrigado por registrar.',
                        message: 'Reconhecer o que sentimos é um passo importante para o autocuidado.',
                        btnClass: 'feedback-amber'
                    },
                    vermelho: {
                        iconSvg: '<svg class="icon" style="color: #ef4444;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
                        color: 'text-red-500',
                        title: 'Sinto muito por isso.',
                        message: 'Lembre-se de ser gentil com você mesmo. Se precisar, procure apoio nos Recursos.',
                        btnClass: 'feedback-red'
                    }
                };

                const data = feedbackData[mood];
                iconContainer.innerHTML = data.iconSvg;
                titleEl.textContent = data.title;
                messageEl.textContent = data.message;
                continueBtn.className = `button-primary ${data.btnClass}`;
            };

            const openEditModal = (checkinId) => {
                const checkinToEdit = state.checkins.find(c => c.id === checkinId);
                if (!checkinToEdit) return;

                state.editingCheckinId = checkinId;
                state.editingTags = [...checkinToEdit.tags];

                document.getElementById('edit-notes').value = checkinToEdit.notes;
                renderPredefinedTags('edit-predefined-tags-container', state.editingTags);
                
                editModal.classList.remove('hidden');
                const modalContent = document.getElementById('edit-modal-content');
                modalContent.classList.remove('modal-leave');
                modalContent.classList.add('modal-enter');
            };

            const closeEditModal = () => {
                state.editingCheckinId = null;
                state.editingTags = [];

                const modalContent = document.getElementById('edit-modal-content');
                modalContent.classList.remove('modal-enter');
                modalContent.classList.add('modal-leave');

                modalContent.addEventListener('animationend', (e) => {
                    // Only hide if the close animation was the last one triggered
                    if (modalContent.classList.contains('modal-leave')) {
                        editModal.classList.add('hidden');
                    }
                }, { once: true });
            };

            const renderCalendar = () => {
                const calendarGrid = document.getElementById('calendar-grid');
                const monthYearEl = document.getElementById('calendar-month-year');
                if (!calendarGrid || !monthYearEl) return;

                const now = state.calendarDate;
                const year = now.getFullYear();
                const month = now.getMonth();

                monthYearEl.textContent = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon,...
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                calendarGrid.innerHTML = '';

                // Day names header
                const dayNames = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                dayNames.forEach(day => {
                    calendarGrid.innerHTML += `<div class="font-bold text-sm text-text-muted">${day}</div>`;
                });

                // Blank days for padding
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGrid.innerHTML += '<div></div>';
                }

                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(year, month, day);
                    const checkinsForDay = state.checkins.filter(c => {
                        const checkinDate = new Date(c.createdAt);
                        return checkinDate.getFullYear() === year &&
                               checkinDate.getMonth() === month &&
                               checkinDate.getDate() === day;
                    });

                    let moodDot = '';
                    if (checkinsForDay.length > 0) {
                        let dayMood = 'verde'; // default to green
                        if (checkinsForDay.some(c => c.mood === 'vermelho')) dayMood = 'vermelho';
                        else if (checkinsForDay.some(c => c.mood === 'amarelo')) dayMood = 'amarelo';
                        
                        const moodColor = { verde: '#22c55e', amarelo: '#f59e0b', vermelho: '#ef4444' }[dayMood];
                        moodDot = `<div class="mood-dot" style="background-color: ${moodColor};"></div>`;
                    }
                    
                    const today = new Date();
                    const isSelected = state.selectedDate && dayDate.toDateString() === state.selectedDate.toDateString();
                    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                    let dayClasses = 'calendar-day';
                    if (isToday) dayClasses += ' today';
                    if (isSelected) dayClasses += ' selected';

                    calendarGrid.innerHTML += `
                        <button data-date="${dayDate.toISOString()}" class="${dayClasses}">
                            <span>${day}</span>
                            ${moodDot}
                        </button>
                    `;
                }
            };

            const renderHistoryFilters = () => {
                const container = document.getElementById('history-tags-filter');
                const filterContainer = document.getElementById('history-filter-container');
                if (!container || !filterContainer) return;

                const allTags = [...new Set(state.checkins.flatMap(c => c.tags))];

                if (allTags.length === 0) {
                    filterContainer.style.display = 'none';
                    return;
                }
                filterContainer.style.display = 'block';

                let tagsHTML = '';
                
                const allSelected = state.historyFilterTag === null;
                tagsHTML += `<button type="button" data-tag="all" class="tag-btn history-filter-btn ${allSelected ? 'selected' : ''}">Todos</button>`;

                allTags.sort().forEach(tag => {
                    const isSelected = state.historyFilterTag === tag;
                    tagsHTML += `<button type="button" data-tag="${tag}" class="tag-btn history-filter-btn ${isSelected ? 'selected' : ''}">${tag}</button>`;
                });

                container.innerHTML = tagsHTML;
            };

            const renderHistory = () => {
                const listContainer = document.getElementById('history-list');
                const noHistoryEl = document.getElementById('no-history');
                const historyContentEl = document.getElementById('history-content');

                const chartsContainer = document.getElementById('charts-container');
                const filterContainer = document.getElementById('history-filter-container');
                const zenModeToggle = document.getElementById('zen-mode-toggle');

                if (state.isZenMode) {
                    chartsContainer.style.display = 'none';
                    filterContainer.style.display = 'none';
                    zenModeToggle.classList.add('active');
                } else {
                    chartsContainer.style.display = 'block';
                    zenModeToggle.classList.remove('active');
                }



                renderCalendar();
                renderHistoryFilters();

                const year = state.calendarDate.getFullYear();
                const month = state.calendarDate.getMonth();

                // Filter checkins for the current calendar month to display
                const monthCheckins = state.checkins.filter(c => {
                    const checkinDate = new Date(c.createdAt);
                    return checkinDate.getFullYear() === year && checkinDate.getMonth() === month;
                });

                // Data for charts is based on month + tag filter
                const chartCheckins = state.historyFilterTag
                    ? monthCheckins.filter(c => c.tags.includes(state.historyFilterTag))
                    : monthCheckins;
                
                // Data for list is based on day filter (if active) or the same as charts
                const listCheckins = state.selectedDate
                    ? monthCheckins.filter(c => new Date(c.createdAt).getDate() === state.selectedDate.getDate())
                    : chartCheckins;

                if (monthCheckins.length === 0) {
                    renderEmptyState(noHistoryEl, 'archive', 'Nenhum registro encontrado ainda.');
                    noHistoryEl.style.display = 'block';
                    historyContentEl.style.display = 'none';
                    return;
                }
                
                if (listCheckins.length === 0) {
                    renderEmptyState(noHistoryEl, 'filter', 'Nenhum registro encontrado para a seleção atual.');
                    noHistoryEl.style.display = 'block';
                    historyContentEl.style.display = 'none';
                    return;
                }

                noHistoryEl.style.display = 'none';
                historyContentEl.style.display = 'block';
                
                const sortedCheckins = [...listCheckins].sort((a, b) => b.createdAt - a.createdAt);

                listContainer.innerHTML = sortedCheckins.map(checkin => `
                    <div class="history-item" style="border-left-color: ${getMoodBorderColor(checkin.mood)};">
                        <div class="history-item-content">
                            <p class="font-bold">${getMoodName(checkin.mood)} - ${checkin.createdAt.toLocaleDateString('pt-BR')}</p>
                            <p class="text-secondary" style="font-size: 0.875rem;">${checkin.notes || 'Nenhuma nota adicionada.'}</p>
                            ${checkin.tags.length > 0 ? `<div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">${checkin.tags.map(t => `<span style="font-size: 0.75rem; background-color: rgb(var(--color-bg-tertiary)); color: rgb(var(--color-text-primary)); padding: 0.125rem 0.5rem; border-radius: 9999px;">${t}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="history-item-actions">
                            <button data-action="edit" data-id="${checkin.id}" class="edit-btn"><svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button data-action="delete" data-id="${checkin.id}" class="delete-btn"><svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>
                `).join('');
                
                if (!state.isZenMode) {
                    renderCharts(chartCheckins);
                }
            };

            const renderDiagnosis = () => {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const weeklyCheckins = state.checkins.filter(c => c.createdAt >= oneWeekAgo);

                const diagnosisContent = document.getElementById('diagnosis-content');
                const noDataEl = document.getElementById('no-diagnosis-data');

                if (weeklyCheckins.length === 0) {
                    diagnosisContent.style.display = 'none';
                    noDataEl.style.display = 'block';
                    return;
                }

                diagnosisContent.style.display = 'block';
                noDataEl.style.display = 'none';

                const moodCounts = weeklyCheckins.reduce((acc, c) => {
                    acc[c.mood] = (acc[c.mood] || 0) + 1;
                    return acc;
                }, { verde: 0, amarelo: 0, vermelho: 0 });

                const barContainer = document.getElementById('weekly-bar-chart-container');
                const maxCount = Math.max(1, moodCounts.verde, moodCounts.amarelo, moodCounts.vermelho);
                barContainer.innerHTML = `
                    <div class="simple-bar-chart">
                        <div class="bar-item">
                            <div class="bar" style="height: ${ (moodCounts.verde / maxCount) * 100 }%; background-color: #22c55e;"></div>
                            <span>Bem</span>
                        </div>
                        <div class="bar-item">
                            <div class="bar" style="height: ${ (moodCounts.amarelo / maxCount) * 100 }%; background-color: #f59e0b;"></div>
                            <span>Ok</span>
                        </div>
                        <div class="bar-item">
                            <div class="bar" style="height: ${ (moodCounts.vermelho / maxCount) * 100 }%; background-color: #ef4444;"></div>
                            <span>Mal</span>
                        </div>
                    </div>
                `;


                const titleEl = document.getElementById('diagnosis-title');
                const textEl = document.getElementById('diagnosis-text');
                const total = weeklyCheckins.length;
                const predominantMood = Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b);
                let diagnosis = {};

                if (moodCounts.vermelho >= total / 2 || (predominantMood === 'vermelho' && moodCounts.vermelho > 0)) {
                    diagnosis = {
                        title: "Uma Semana Desafiadora",
                        text: "Parece que esta foi uma semana difícil. É importante reconhecer o peso que o cenário atual, social e político, pode ter sobre nós. Lembre-se que seu sentimento é válido. Considere se conectar com grupos de apoio ou canais que fortaleçam sua comunidade. Cuidar de si é também um ato de resistência."
                    };
                } else if (moodCounts.amarelo > total / 2 || predominantMood === 'amarelo') {
                    diagnosis = {
                        title: "Uma Semana de Alerta",
                        text: "Sua semana teve momentos de atenção. Em um mundo com excesso de informações, é crucial filtrar o que consumimos. Que tal praticar o 'detox digital', checar as fontes das notícias e buscar conversas que construam, em vez de apenas drenar? O equilíbrio é fundamental para a ação consciente."
                    };
                } else {
                    diagnosis = {
                        title: "Uma Semana Positiva!",
                        text: "Que ótimo ver uma semana com mais bem-estar! Essa energia positiva é um recurso valioso. Já pensou em usá-la para se engajar em uma causa local, aprender mais sobre os direitos da sua comunidade ou simplesmente compartilhar uma conversa construtiva com alguém? Pequenas ações fortalecem o coletivo."
                    };
                }

                titleEl.textContent = diagnosis.title;
                textEl.textContent = diagnosis.text;
            };

            const renderCharts = (checkinsToRender) => {
                const trendContainer = document.getElementById('trend-chart-container');
                const pieContainer = document.getElementById('mood-pie-chart-container');
                
                // Trend Chart
                if (checkinsToRender.length > 0) {
                    trendContainer.innerHTML = `<ul style="list-style: none; padding: 1rem; background-color: rgb(var(--color-bg-tertiary)); border-radius: 0.5rem;">${[...checkinsToRender].sort((a,b) => a.createdAt - b.createdAt).map(c => `<li>${c.createdAt.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})}: <span style="font-weight: 600; color: ${getMoodBorderColor(c.mood).replace('border-', '')};">${getMoodName(c.mood)}</span></li>`).join('')}</ul>`;
                } else {
                    trendContainer.innerHTML = `<p class="text-muted text-center">Sem dados</p>`;
                }

                // Pie Chart
                const moodCounts = checkinsToRender.reduce((acc, c) => {
                    acc[c.mood] = (acc[c.mood] || 0) + 1;
                    return acc;
                }, {});
                const total = checkinsToRender.length;

                if (total > 0) {
                    pieContainer.innerHTML = `
                        <div class="simple-pie-chart">
                            ${Object.keys(moodCounts).map(mood => {
                                const percentage = ((moodCounts[mood] / total) * 100).toFixed(0);
                                const color = { verde: '#22c55e', amarelo: '#f59e0b', vermelho: '#ef4444' }[mood];
                                return `<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color}; margin-right: 0.5rem;"></span>
                                    <span>${getMoodName(mood)}: <strong>${percentage}%</strong></span>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                } else {
                    pieContainer.innerHTML = `<p class="text-muted text-center">Sem dados</p>`;
                }
            };

            const renderResources = () => {
                const allList = document.getElementById('resources-list');
                const suggestedContainer = document.getElementById('suggested-resources');
                
                const createResourceCard = (resource) => `
                    <a href="${resource.contentUrl}" target="_blank" style="display: block; background-color: rgb(var(--color-bg-secondary)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgb(var(--color-border-primary)); text-decoration: none;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <svg class="icon" style="width: 1.25rem; height: 1.25rem; color: rgb(var(--color-accent));" viewBox="0 0 24 24">${iconLibrary[resource.icon] || ''}</svg>
                            <h4 style="font-size: 1.125rem; margin: 0;">${resource.title}</h4>
                        </div>
                        <p style="font-size: 0.875rem; margin: 0;">${resource.description}</p>
                    </a>
                `;
                
                allList.innerHTML = mockResources.map(createResourceCard).join('');
                
                let suggestionHTML = '';
                const lastCheckin = state.checkins.length > 0 ? [...state.checkins].sort((a, b) => b.createdAt - a.createdAt)[0] : null;

                if (lastCheckin && (lastCheckin.mood === 'vermelho' || lastCheckin.mood === 'amarelo')) {
                    // 1. Contextual suggestions based on tags
                    const checkinTags = lastCheckin.tags;
                    const contextualResources = mockResources.filter(r => 
                        r.category === 'contextual' && checkinTags.some(tag => r.tags.includes(tag))
                    );

                    if (contextualResources.length > 0) {
                        suggestionHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 class="text-xl font-bold mb-4">Sugestões para seu Contexto</h3>
                                <div class="space-y-4">
                                    ${contextualResources.map(createResourceCard).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // 2. General suggestions (Calm/Release)
                    const calmResources = mockResources.filter(r => r.category === 'calm');
                    const releaseResources = mockResources.filter(r => r.category === 'release');

                    if (calmResources.length > 0) {
                        suggestionHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 class="text-xl font-bold mb-4">Para Acalmar a Mente</h3>
                                <div class="space-y-4">${calmResources.map(createResourceCard).join('')}</div>
                            </div>`;
                    }
                    if (releaseResources.length > 0) {
                        suggestionHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 class="text-xl font-bold mb-4">Para Extravasar o Emocional</h3>
                                <div class="space-y-4">${releaseResources.map(createResourceCard).join('')}</div>
                            </div>`;
                    }
                }

                if (suggestionHTML) {
                    suggestedContainer.innerHTML = suggestionHTML + '<hr style="margin: 2rem 0; border-color: rgb(var(--color-border-primary));">';
                } else {
                    suggestedContainer.innerHTML = '';
                }
                
            };
            
            const handleDeleteCheckin = (checkinId) => {
                if (confirm('Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.')) {
                    state.checkins = state.checkins.filter(c => c.id !== checkinId);
                    saveState();
                    renderHistory();
                }
            };

            const updateThemeSelector = () => {
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === state.theme);
                });
            };
            

            const calculateStreaks = () => {
                const checkins = state.checkins;
                if (checkins.length === 0) {
                    return { current: 0, longest: 0 };
                }

                const uniqueDays = [...new Set(checkins.map(c => new Date(c.createdAt).toDateString()))]
                    .map(dateStr => new Date(dateStr))
                    .sort((a, b) => a - b);

                if (uniqueDays.length === 0) {
                    return { current: 0, longest: 0 };
                }

                // Calculate longest streak
                let longestStreak = 0;
                let currentLongest = 1;
                for (let i = 1; i < uniqueDays.length; i++) {
                    if (isConsecutiveDay(uniqueDays[i - 1], uniqueDays[i])) {
                        currentLongest++;
                    } else {
                        longestStreak = Math.max(longestStreak, currentLongest);
                        currentLongest = 1;
                    }
                }
                longestStreak = Math.max(longestStreak, currentLongest);

                // Calculate current streak
                let currentStreak = 0;
                const today = new Date();
                today.setHours(0,0,0,0);
                const lastCheckinDay = uniqueDays[uniqueDays.length - 1];

                if (isSameDay(today, lastCheckinDay) || isConsecutiveDay(lastCheckinDay, today)) {
                    currentStreak = 1;
                    for (let i = uniqueDays.length - 2; i >= 0; i--) {
                        if (isConsecutiveDay(uniqueDays[i], uniqueDays[i + 1])) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                }
                
                return { current: currentStreak, longest: longestStreak };
            };

            const showAchievementUnlockedModal = (achievement) => {
                document.getElementById('unlocked-achievement-title').textContent = achievement.title;
                document.getElementById('unlocked-achievement-desc').textContent = achievement.description;
                const modal = document.getElementById('achievement-unlocked-modal');
                modal.classList.remove('hidden');
                document.getElementById('achievement-modal-content').classList.add('modal-enter');
            };

            const updateStreaksAndAchievements = () => {
                const oldLongestStreak = state.streaks.longest;
                state.streaks = calculateStreaks();

                achievementsData.forEach(achievement => {
                    if (achievement.requirement.type === 'streak' && !state.unlockedAchievements.includes(achievement.id)) {
                        if (state.streaks.longest >= achievement.requirement.value) {
                            state.unlockedAchievements.push(achievement.id);
                            if (state.streaks.longest > oldLongestStreak) {
                                showAchievementUnlockedModal(achievement);
                            }
                        }
                    }
                });
            };

            const renderAchievements = () => {
                const list = document.getElementById('achievements-list');
                list.innerHTML = achievementsData.map(ach => {
                    const isUnlocked = state.unlockedAchievements.includes(ach.id);
                    const unlockedStyle = 'background-color: rgb(var(--color-accent-bg-light)); border-color: rgb(var(--color-accent)); color: rgb(var(--color-accent-text-dark));';
                    const lockedStyle = 'background-color: rgb(var(--color-bg-tertiary)); border-color: rgb(var(--color-border-primary)); color: rgb(var(--color-text-muted)); opacity: 0.6;';
                    return `
                        <div style="padding: 1rem; border-radius: 0.5rem; border: 2px solid; display: flex; flex-direction: column; align-items: center; text-align: center; ${isUnlocked ? unlockedStyle : lockedStyle}">
                            <svg class="icon" style="width: 2.5rem; height: 2.5rem; margin-bottom: 0.75rem;" viewBox="0 0 24 24">${iconLibrary[ach.icon] || ''}</svg>
                            <h4 class="font-bold">${ach.title}</h4>
                            <p style="font-size: 0.75rem;">${ach.description}</p>
                        </div>
                    `;
                }).join('');
            };

            // --- EVENT LISTENERS ---
            document.getElementById('get-started-btn').addEventListener('click', () => {
                navigateTo('mandatory-contact-screen');
            });

            const renderMandatoryContacts = () => {
                const listContainer = document.getElementById('mandatory-contacts-list');
                
                listContainer.innerHTML = state.favoriteContacts.map(contact => `
                    <div class="contact-card">
                        <span class="font-semibold" style="flex-grow: 1;">${contact.name}</span>
                        <button data-id="${contact.id}" class="remove-mandatory-contact-btn" style="color: #ef4444;">
                            <svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `).join('');
            };

            document.getElementById('add-mandatory-contact-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('mandatory-contact-name-input');
                const phoneInput = document.getElementById('mandatory-contact-phone-input');
                const name = nameInput.value.trim();
                const phone = phoneInput.value.trim();

                if (name && phone) {
                    state.favoriteContacts.push({ id: Date.now(), name, phone });
                    renderMandatoryContacts();
                    nameInput.value = '';
                    phoneInput.value = '';
                }
            });

            document.getElementById('mandatory-contacts-list').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-mandatory-contact-btn');
                if (removeBtn) { // This list is simple, so a full re-render is acceptable.
                    const contactId = removeBtn.dataset.id;
                    state.favoriteContacts = state.favoriteContacts.filter(c => c.id.toString() !== contactId);
                    renderMandatoryContacts();
                }
            });

            const proceedToMainApp = () => {
                state.isAuthenticated = true;
                header.classList.remove('hidden');
                bottomNavBar.classList.remove('hidden');
                navSpacer.style.display = 'block';
                navigateTo('checkin-screen');
            };

            document.getElementById('mandatory-contact-continue-btn').addEventListener('click', proceedToMainApp);
            document.getElementById('skip-contact-btn').addEventListener('click', proceedToMainApp);

            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.currentMood = e.currentTarget.dataset.mood;
                    document.getElementById('save-checkin-btn').className = `button-primary ${state.currentMood}`;
                    navigateTo('details-screen');
                });
            });
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const screenId = e.currentTarget.dataset.screen;
                    navigateTo(screenId);
                });
            });

            document.getElementById('predefined-tags-container').addEventListener('click', (e) => {
                const target = e.target.closest('.tag-btn');
                if (!target) return;

                const tag = target.dataset.tag;
                if (state.currentTags.includes(tag)) {
                    state.currentTags = state.currentTags.filter(t => t !== tag);
                } else {
                    state.currentTags.push(tag);
                }
                renderPredefinedTags('predefined-tags-container', state.currentTags);
            });

            document.getElementById('details-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newCheckin = {
                    id: Date.now().toString(),
                    mood: state.currentMood,
                    notes: document.getElementById('notes').value,
                    tags: [...state.currentTags],
                    createdAt: new Date(),
                };
                state.checkins.push(newCheckin);
                updateStreaksAndAchievements();
                saveState();

                // Reset form state
                document.getElementById('notes').value = '';
                state.currentTags = [];

                // Render and navigate to feedback screen
                renderFeedbackScreen(state.currentMood);
                navigateTo('feedback-screen');
            });

            document.getElementById('feedback-continue-btn').addEventListener('click', () => {
                const lastCheckin = state.checkins.length > 0 ? [...state.checkins].sort((a, b) => b.createdAt - a.createdAt)[0] : null;
                if (lastCheckin && (lastCheckin.mood === 'amarelo' || lastCheckin.mood === 'vermelho')) {
                    renderContextualTips();
                    navigateTo('contextual-tips-screen');
                } else {
                    navigateTo('checkin-screen');
                }
            });

            document.getElementById('app-container').addEventListener('click', (e) => {
                const journeyLink = e.target.closest('.journey-link');
                if (journeyLink) {
                    const screenId = journeyLink.dataset.screen;
                    navigateTo(screenId);
                }
            });

            document.getElementById('add-resources-contact-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('resources-contact-name-input');
                const phoneInput = document.getElementById('resources-contact-phone-input');
                const name = nameInput.value.trim();
                const phone = phoneInput.value.trim();

                if (name && phone) {
                    state.favoriteContacts.push({ id: Date.now(), name, phone });
                    renderEmergencyContacts();
                    nameInput.value = '';
                    phoneInput.value = '';
                }
            });

            document.getElementById('emergency-help-section').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-resources-contact-btn');
                if (removeBtn) {
                    const contactId = removeBtn.dataset.id;
                    state.favoriteContacts = state.favoriteContacts.filter(c => c.id.toString() !== contactId);
                    renderEmergencyContacts();
                }
            });

            document.getElementById('history-filter-container').addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.history-filter-btn');
                if (filterBtn) {
                    const tag = filterBtn.dataset.tag;
                    state.historyFilterTag = tag === 'all' ? null : tag;
                    state.selectedDate = null; // Reset day selection
                    renderHistory();
                }
            });

            document.getElementById('zen-mode-toggle').addEventListener('click', () => {
                state.isZenMode = !state.isZenMode;
                renderHistory();
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                state.selectedDate = null;
                state.historyFilterTag = null;
                renderHistory();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                state.selectedDate = null;
                state.historyFilterTag = null;
                renderHistory();
            });

            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                const dayBtn = e.target.closest('.calendar-day');
                if (!dayBtn || !dayBtn.dataset.date) return;

                const clickedDate = new Date(dayBtn.dataset.date);

                state.selectedDate = (state.selectedDate && state.selectedDate.getTime() === clickedDate.getTime()) ? null : clickedDate;
                state.historyFilterTag = null;
                renderHistory();
            });

            document.getElementById('history-list').addEventListener('click', (e) => {
                const targetButton = e.target.closest('button[data-action]');
                if (!targetButton) return;

                const action = targetButton.dataset.action;
                const checkinId = targetButton.dataset.id;

                if (action === 'edit') {
                    openEditModal(checkinId);
                } else if (action === 'delete') {
                    handleDeleteCheckin(checkinId);
                }
            });

            document.getElementById('tips-continue-btn').addEventListener('click', () => {
                navigateTo('checkin-screen');
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);

            document.getElementById('edit-predefined-tags-container').addEventListener('click', (e) => {
                const target = e.target.closest('.predefined-tag-btn');
                if (!target) return;

                const tag = target.dataset.tag;
                if (state.editingTags.includes(tag)) {
                    state.editingTags = state.editingTags.filter(t => t !== tag);
                } else {
                    state.editingTags.push(tag);
                }
                renderPredefinedTags('edit-predefined-tags-container', state.editingTags);
            });
            document.getElementById('edit-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const checkinIndex = state.checkins.findIndex(c => c.id === state.editingCheckinId);
                if (checkinIndex === -1) return;
                state.checkins[checkinIndex].notes = document.getElementById('edit-notes').value;
                state.checkins[checkinIndex].tags = [...state.editingTags];
                saveState();
                renderHistory();
                closeEditModal();
            });

            document.getElementById('close-achievement-modal-btn').addEventListener('click', () => {
                const modal = document.getElementById('achievement-unlocked-modal');
                const modalContent = document.getElementById('achievement-modal-content');
                modalContent.classList.add('modal-leave');
                modalContent.addEventListener('animationend', () => modal.classList.add('hidden'), { once: true });
            });

            const createGoalElement = (goal) => {
                const div = document.createElement('div');
                div.className = 'goal-item';
                const completedStyle = goal.completed ? 'text-decoration: line-through; color: rgb(var(--color-text-muted));' : '';
                div.innerHTML = `
                    <input type="checkbox" data-id="${goal.id}" class="goal-checkbox" style="width: 1.5rem; height: 1.5rem; border-radius: 0.25rem; color: rgb(var(--color-accent));" ${goal.completed ? 'checked' : ''}>
                    <span style="flex-grow: 1; ${completedStyle}">${goal.text}</span>
                    <button data-id="${goal.id}" class="remove-goal-btn" style="color: rgb(var(--color-text-muted));">
                        <svg class="icon" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
                return div;
            };

            const renderGoals = () => {
                const list = document.getElementById('goals-list');
                if (!list) return;

                if (state.goals.length === 0) {
                    list.innerHTML = `<div class="text-center text-muted" style="padding: 2rem;">
                        <svg class="icon" style="width: 3rem; height: 3rem; margin: 0 auto 1rem;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        <p>Nenhuma meta definida ainda. Adicione uma acima!</p>
                    </div>`;
                    return;
                }

                list.innerHTML = state.goals.map(goal => createGoalElement(goal).outerHTML).join('');
            };

            document.getElementById('add-new-goal-btn').addEventListener('click', () => {
                const input = document.getElementById('new-goal-input');
                const text = input.value.trim();
                if (text) {
                    const newGoal = { id: Date.now(), text, completed: false };
                    state.goals.push(newGoal);
                    saveState();

                    const list = document.getElementById('goals-list');
                    if (state.goals.length === 1) {
                        list.innerHTML = ''; // Clear "empty" message
                    }
                    const goalElement = createGoalElement(newGoal);
                    goalElement.classList.add('list-item-enter');
                    list.appendChild(goalElement);

                    input.value = '';
                }
            });

            document.getElementById('goals-list').addEventListener('click', (e) => {
                const checkbox = e.target.closest('.goal-checkbox');
                const removeBtn = e.target.closest('.remove-goal-btn');

                if (checkbox) {
                    const goalId = checkbox.dataset.id;
                    const goal = state.goals.find(g => g.id.toString() === goalId);
                    if (goal) {
                        goal.completed = !goal.completed;
                        saveState();
                        const span = checkbox.nextElementSibling;
                        span.style.textDecoration = goal.completed ? 'line-through' : 'none';
                        span.style.color = goal.completed ? 'rgb(var(--color-text-muted))' : 'rgb(var(--color-text-primary))';
                    }
                }

                if (removeBtn) {
                    const goalId = removeBtn.dataset.id;
                    const goalElement = removeBtn.closest('.goal-item');
                    goalElement.classList.add('list-item-leave');
                    goalElement.addEventListener('animationend', () => {
                        state.goals = state.goals.filter(g => g.id.toString() !== goalId);
                        saveState();
                        goalElement.remove();
                        if (state.goals.length === 0) { renderGoals(); }
                    }, { once: true });
                }
            });

            const createGratitudeElement = (entry) => {
                const div = document.createElement('div');
                div.className = 'gratitude-item';
                div.innerHTML = `
                    <p style="color: rgb(var(--color-text-primary)); margin: 0;">${entry.text}</p>
                    <p style="font-size: 0.75rem; color: rgb(var(--color-text-muted)); margin-top: 0.5rem; text-align: right;">${new Date(entry.createdAt).toLocaleDateString('pt-BR')}</p>
                `;
                return div;
            };
            const renderGratitudeJournal = () => {
                const list = document.getElementById('gratitude-entries-list');
                if (!list) return;

                if (state.gratitudeEntries.length === 0) {
                    list.innerHTML = `<div class="text-center text-muted" style="padding: 2rem;">
                        <svg class="icon" style="width: 3rem; height: 3rem; margin: 0 auto 1rem;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <p>Nenhum registro de gratidão ainda. Adicione um para começar!</p>
                    </div>`;
                    return;
                }

                const sortedEntries = [...state.gratitudeEntries].sort((a, b) => b.createdAt - a.createdAt);
                list.innerHTML = sortedEntries.map(entry => createGratitudeElement(entry).outerHTML).join('');
            };

            document.getElementById('add-new-gratitude-entry-btn').addEventListener('click', () => {
                const input = document.getElementById('new-gratitude-entry-input');
                const text = input.value.trim();
                if (text) {
                    const newEntry = { id: Date.now(), text, createdAt: new Date() };
                    state.gratitudeEntries.push(newEntry);
                    saveState();
                    
                    const list = document.getElementById('gratitude-entries-list');
                    if (state.gratitudeEntries.length === 1) { list.innerHTML = ''; }
                    const entryElement = createGratitudeElement(newEntry);
                    entryElement.classList.add('list-item-enter');
                    list.prepend(entryElement); // Prepend for journal style

                    input.value = '';
                }
            });

            document.getElementById('theme-selector').addEventListener('click', (e) => {
                const themeBtn = e.target.closest('.theme-btn');
                if (themeBtn) {
                    state.theme = themeBtn.dataset.theme;
                    applyTheme(state.theme);
                    saveState();
                    if (state.currentScreen === 'history-screen' || state.currentScreen === 'diagnosis-screen') {
                        navigateTo(state.currentScreen); // Re-render to update charts
                    }
                }
            });

            document.getElementById('add-new-tag-btn').addEventListener('click', () => {
                const input = document.getElementById('new-tag-input');
                const newTag = input.value.trim();
                if (newTag && !state.predefinedTags.find(t => t.toLowerCase() === newTag.toLowerCase())) {
                    state.predefinedTags.push(newTag);
                    saveState();
                    
                    const list = document.getElementById('tag-management-list');
                    const tagElement = createTagManagementElement(newTag);
                    tagElement.classList.add('list-item-enter');
                    list.appendChild(tagElement);

                    input.value = '';
                }
            });

            document.getElementById('settings-screen').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-managed-tag-btn');
                if (removeBtn) {
                    const tagToRemove = removeBtn.dataset.tag;
                    const tagElement = removeBtn.closest('.tag-management-item');
                    tagElement.classList.add('list-item-leave');
                    tagElement.addEventListener('animationend', () => {
                        state.predefinedTags = state.predefinedTags.filter(t => t !== tagToRemove);
                        saveState();
                        tagElement.remove();
                    }, { once: true });
                }
            });

            // --- DATA EXPORT & IMPORT ---
            const exportData = () => {
                // Create a deep copy to avoid modifying the original state's Date objects
                const dataToExport = JSON.parse(JSON.stringify({
                    checkins: state.checkins,
                    goals: state.goals,
                    gratitudeEntries: state.gratitudeEntries,
                    favoriteContacts: state.favoriteContacts,
                    predefinedTags: state.predefinedTags,
                    theme: state.theme,
                    unlockedAchievements: state.unlockedAchievements,
                    streaks: state.streaks,
                    isAuthenticated: state.isAuthenticated,
                }));

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const today = new Date().toISOString().split('T')[0];
                link.download = `sinais-backup-${today}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-data-btn').addEventListener('click', () => importFileInput.click());

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData || typeof importedData !== 'object' || !importedData.checkins) {
                            alert('Arquivo de backup inválido ou corrompido.');
                            return;
                        }
                        if (!confirm('Isso substituirá todos os seus dados atuais. Deseja continuar?')) return;

                        // Restore state, converting date strings back to Date objects
                        state.checkins = (importedData.checkins || []).map(c => ({ ...c, createdAt: new Date(c.createdAt) }));
                        state.goals = importedData.goals || [];
                        state.gratitudeEntries = (importedData.gratitudeEntries || []).map(g => ({ ...g, createdAt: new Date(g.createdAt) }));
                        state.favoriteContacts = importedData.favoriteContacts || [];
                        state.predefinedTags = importedData.predefinedTags || ["Trabalho", "Família", "Relacionamentos", "Saúde", "Lazer", "Estudos", "Finanças", "Pessoal"];
                        state.theme = importedData.theme || 'light';
                        state.unlockedAchievements = importedData.unlockedAchievements || [];
                        state.streaks = importedData.streaks || { current: 0, longest: 0 };
                        state.isAuthenticated = importedData.isAuthenticated || false;

                        alert('Dados importados com sucesso!');
                        initializeApp(); // Re-render everything
                    } catch (error) {
                        alert('Ocorreu um erro ao ler o arquivo de backup.');
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- APP INITIALIZATION ---
            const initializeApp = () => {
                applyTheme(state.theme);
                if (state.isAuthenticated) {
                    header.classList.remove('hidden');
                    bottomNavBar.classList.remove('hidden');
                    navSpacer.style.display = 'block';
                    navigateTo('checkin-screen');
                } else {
                    navigateTo('welcome-screen');
                }
            };

            loadState();
            initializeApp();
        });
    </script>
</body>
</html>
